<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Custom Styles for Home page -->
    <link rel="stylesheet" href="home.css">

    <!-- Tone.js for sound effects, loaded globally for all pages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Firebase SDKs (UPDATED: Using standard scripts for GitHub Pages compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <div class="background-overlay"></div>

    <div class="content-wrapper">
        <header class="text-center">
            <h1 class="text-5xl md:text-7xl font-black uppercase tracking-wider title-shadow">
                Game Hub
            </h1>
            <p class="mt-4 max-w-2xl text-lg md:text-xl text-gray-300 subtitle-shadow">
                Welcome to my collection of simple and fun browser games. Select a game below to get started!
            </p>
        </header>

        <!-- Auth Status and Button -->
        <div class="flex items-center gap-4 mt-6">
            <span id="auth-status" class="text-gray-300 text-lg">Signed out</span>
            <button id="auth-button" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                Sign In / Register
            </button>
        </div>

        <!-- Search Bar -->
        <div class="search-bar mt-8 w-full max-w-md flex items-center justify-center gap-2">
            <input type="text" id="game-search" placeholder="Search for games..." class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
            <button id="search-button" class="px-4 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                <i class="fas fa-search"></i>
            </button>
        </div>

        <!-- Main content area for game cards. Using a responsive grid layout to ensure 3 columns on larger screens. -->
        <!-- Added horizontal padding (px-4) to provide space for hover effects. -->
        <!-- Using a responsive grid: 1 column on small screens, 2 on medium, 3 on large. -->
        <main class="game-library mt-12 w-full max-w-screen-md grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 py-4 px-4">
            <!-- Game Card: 2048 -->
            <div class="game-card flex-shrink-0 w-full h-36 transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl" data-hover-sound="cardHover" data-game-id="2048">
                <div class="game-card-content flex flex-col justify-center items-center h-full text-center">
                    <div class="game-card-title text-xl">2048</div>
                    <p class="game-card-description text-xs text-gray-400">
                        Join numbers to get 2048 tile.
                    </p>
                    <a href="game.html" class="play-button px-3 py-1 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 text-sm transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                        Play Now
                    </a>
                </div>
            </div>

            <!-- Game Card: Tic-Tac-Toe -->
            <div class="game-card flex-shrink-0 w-full h-36 transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl" data-hover-sound="cardHover" data-game-id="ticTacToe">
                <div class="game-card-content flex flex-col justify-center items-center h-full text-center">
                    <div class="game-card-title text-xl">Tic-Tac-Toe</div>
                    <p class="game-card-description text-xs text-gray-400">
                        Classic game vs friend or AI.
                    </p>
                    <div class="flex justify-center gap-2 w-full">
                        <a href="tic_tac_toe.html" class="play-button-small px-3 py-1 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 text-xs transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                            Vs Friend
                        </a>
                        <a href="tic_tac_toe_ai.html" class="play-button-small px-3 py-1 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 text-xs transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                            Vs AI
                        </a>
                    </div>
                </div>
            </div>

            <!-- Game Card: Hangman -->
            <div class="game-card flex-shrink-0 w-full h-36 transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl" data-hover-sound="cardHover" data-game-id="hangman">
                <div class="game-card-content flex flex-col justify-center items-center h-full text-center">
                    <div class="game-card-title text-xl">Hangman</div>
                    <p class="game-card-description text-xs text-gray-400">
                        Guess letters, save the figure!
                    </p>
                    <a href="hangman.html" class="play-button px-3 py-1 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 text-sm transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                        Play Now
                    </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer now relative to the content-wrapper -->
    <footer class="w-full p-4 text-center text-gray-400 text-sm flex-shrink-0">
        <p>
            Created by: Vladyslav Bieliaiev |
            <a href="https://instagram.com/mmacvv" target="_blank" class="text-blue-400 hover:underline">My Instagram</a>
        </p>
    </footer>

    <!-- Mute/Unmute Button -->
    <button id="toggle-all-sound-button" class="fixed top-4 right-4 bg-gray-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl z-30 hover:bg-gray-800 transition-colors duration-200">
        <i class="fas fa-volume-up" id="all-sound-icon"></i>
    </button>

    <!-- Game Information Modal -->
    <div id="game-info-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 text-gray-300 p-6 rounded-lg shadow-xl max-w-lg w-full relative">
            <h2 id="modal-game-title" class="text-3xl font-bold mb-4 text-white">Game Title</h2>
            <p id="modal-game-description" class="mb-4 text-lg">Detailed description of the game.</p>
            <p id="modal-game-rules" class="mb-4">Rules: These are the rules for the game.</p>
            <!-- Add more game-specific info here -->
            <button id="close-game-info-modal" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl font-bold" data-click-sound="buttonClick">&times;</button>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 text-gray-300 p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h2 id="auth-modal-title" class="text-2xl font-bold mb-4 text-white">Sign In</h2>
            <form id="auth-form" class="flex flex-col gap-4">
                <input type="email" id="auth-email" placeholder="Email" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="auth-password" placeholder="Password" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="auth-display-name" placeholder="Display Name (for registration)" class="p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 hidden">
                <p id="auth-error-message" class="text-red-400 text-sm mt-2 hidden"></p>
                <button type="submit" id="auth-submit-button" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">Sign In</button>
            </form>
            <button id="forgot-password-button" class="mt-2 text-sm text-blue-400 hover:underline" data-click-sound="buttonClick">Forgot Password?</button>
            <button id="toggle-auth-mode" class="mt-4 text-blue-400 hover:underline text-sm" data-click-sound="buttonClick">
                Don't have an account? Register
            </button>
            <!-- Google Sign-In Button -->
            <button id="google-sign-in-button" class="mt-4 flex items-center justify-center gap-2 w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">
                <i class="fab fa-google"></i> Sign In with Google
            </button>
            <button id="close-auth-modal" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl font-bold" data-click-sound="buttonClick">&times;</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 text-gray-300 p-6 rounded-lg shadow-xl max-w-sm w-full relative">
            <h2 class="text-2xl font-bold mb-4 text-white">My Profile</h2>
            <p class="mb-2">Hello, <span id="profile-display-name" class="font-bold text-blue-400">Guest</span>!</p>
            <p class="mb-4">Email: <span id="profile-email" class="text-gray-400">Not signed in</span></p>
            <p class="mb-4" id="email-verification-status">Email Verified: <span class="font-bold text-yellow-400">No</span></p>
            <button id="send-verification-email-button" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105 text-sm mt-2 hidden" data-click-sound="buttonClick">Send Verification Email</button>

            <!-- Add more profile info here like wins/losses from Firestore -->
            <button id="profile-sign-out-button" class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition-all duration-300 ease-in-out transform hover:scale-105 mt-4" data-click-sound="buttonClick">Sign Out</button>
            <button id="close-profile-modal" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl font-bold" data-click-sound="buttonClick">&times;</button>
        </div>
    </div>

    <!-- Password Reset Success/Error Modal (Simple Notification) -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 text-gray-300 p-6 rounded-lg shadow-xl max-w-xs w-full relative text-center">
            <h3 id="notification-title" class="text-xl font-bold mb-3 text-white">Notification</h3>
            <p id="notification-message" class="mb-4">Message goes here.</p>
            <button id="close-notification-modal" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105" data-click-sound="buttonClick">OK</button>
        </div>
    </div>


    <script>
        console.log("--- Starting main script execution ---"); // Initial log

        try {
            // Firebase configuration (YOUR CONFIG HAS BEEN INSERTED HERE)
            const firebaseConfig = {
              apiKey: "AIzaSyDYKHgJbQasNpBL0vGrjCz80CjrnqSbTyI",
              authDomain: "game-hub-a99b7.firebaseapp.com",
              projectId: "game-hub-a99b7",
              storageBucket: "game-hub-a99b7.firebasestorage.app",
              messagingSenderId: "328776863852",
              appId: "1:328776863852:web:1adcbbf755fa9854dfc849",
              measurementId: "G-GMTYE5CHRM"
            };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            console.log("Firebase config loaded:", firebaseConfig); // Log config
            console.log("App ID:", appId); // Log app ID

            // Initialize Firebase
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) { // Check if not already initialized
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase app initialized.");
            } else if (typeof firebase === 'undefined') {
                console.error("Firebase global object is not defined. Ensure Firebase SDK scripts are loaded.");
            } else {
                console.log("Firebase app already initialized.");
            }
            
            const auth = firebase.auth();
            const db = firebase.firestore();
            const googleProvider = new firebase.auth.GoogleAuthProvider(); // Initialize Google Auth Provider
            console.log("Firebase Auth, Firestore, and GoogleAuthProvider services initialized.");

            let currentUser = null; // To store current user information

            // Global functions for authentication and Firestore will be attached to window for access from inline script
            window.firebaseApp = firebase.app();
            window.firebaseAuth = auth;
            window.firebaseDb = db;
            window.currentUser = currentUser; // Make currentUser accessible globally

            window.signIn = async (email, password) => {
                try {
                    console.log("Attempting to sign in user:", email);
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    console.log("User signed in:", userCredential.user);
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    console.error("Sign in error:", error.message);
                    return { success: false, error: error.message };
                }
            };

            window.signUp = async (email, password, displayName) => {
                try {
                    console.log("Attempting to sign up user:", email, "with display name:", displayName);
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // Set displayName on the Firebase Auth user object
                    if (displayName) {
                        await user.updateProfile({ displayName: displayName });
                        console.log("User display name updated in Auth:", displayName);
                    }

                    // Send email verification
                    await user.sendEmailVerification();
                    console.log("Verification email sent to:", user.email);

                    // Store additional user info in Firestore
                    await db.collection("artifacts").doc(appId).collection("users").doc(user.uid).collection("profile").doc("data").set({
                        displayName: displayName,
                        email: user.email,
                        emailVerified: user.emailVerified, // Store verification status
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
                    });
                    console.log("User signed up and profile created:", user);
                    return { success: true, user: user };
                } catch (error) {
                    console.error("Sign up error:", error.message);
                    return { success: false, error: error.message };
                }
            };

            window.signOutUser = async () => {
                try {
                    console.log("Attempting to sign out user.");
                    await auth.signOut();
                    console.log("User signed out.");
                    window.currentUser = null;
                    return { success: true };
                } catch (error) {
                    console.error("Sign out error:", error.message);
                    return { success: false, error: error.message };
                }
            };

            // Function to send password reset email
            window.sendPasswordReset = async (email) => {
                try {
                    await auth.sendPasswordResetEmail(email);
                    console.log("Password reset email sent to:", email);
                    return { success: true, message: `Password reset email sent to ${email}. Check your inbox!` };
                } catch (error) {
                    console.error("Password reset error:", error.message);
                    return { success: false, error: error.message };
                }
            };

            // Function for Google Sign-In
            window.signInWithGoogle = async () => {
                try {
                    console.log("Attempting Google Sign-In.");
                    const result = await auth.signInWithPopup(googleProvider);
                    const user = result.user;

                    // ALWAYS update user profile in Firestore with latest info from Google
                    // Use setDoc with { merge: true } to update existing fields without overwriting others
                    await db.collection("artifacts").doc(appId).collection("users").doc(user.uid).collection("profile").doc("data").set({
                        displayName: user.displayName,
                        email: user.email, // Keep email updated, though it won't change for Google
                        emailVerified: user.emailVerified,
                        // Do NOT overwrite createdAt if it already exists by not including it here
                        // If it's a new user, it will be added, if existing, it will be merged
                    }, { merge: true }); // Important: merge ensures existing fields are not deleted

                    console.log("User signed in with Google, profile updated/created:", user);
                    return { success: true, user: user };
                } catch (error) {
                    console.error("Google Sign-In error:", error.message);
                    return { success: false, error: error.message };
                }
            };

            // Function to send email verification for current user
            window.sendVerificationEmail = async () => {
                if (window.currentUser && !window.currentUser.emailVerified) {
                    try {
                        await window.currentUser.sendEmailVerification();
                        console.log("Verification email sent to current user:", window.currentUser.email);
                        return { success: true, message: `Verification email sent to ${window.currentUser.email}. Check your inbox!` };
                    } catch (error) {
                        console.error("Error sending verification email:", error.message);
                        return { success: false, error: error.message };
                    }
                } else {
                    return { success: false, error: "No user signed in or email already verified." };
                }
            };


            window.getUserProfile = async (uid) => {
                try {
                    console.log("Attempting to get user profile for UID:", uid);
                    const docSnap = await db.collection("artifacts").doc(appId).collection("users").doc(uid).collection("profile").doc("data").get();
                    if (docSnap.exists) {
                        console.log("User profile found:", docSnap.data());
                        return { success: true, profile: docSnap.data() };
                    } else {
                        console.warn("No such user profile document for UID:", uid);
                        return { success: false, error: "No profile found" };
                    }
                } catch (error) {
                    console.error("Error getting user profile for UID:", uid, error.message);
                    return { success: false, error: error.message };
                }
            };

            // Function to get the correct display name for UI
            async function getDisplayUserName(user) {
                if (!user) return "Guest"; // If no user, return "Guest"

                // Prioritize Firebase Auth's displayName
                if (user.displayName) {
                    return user.displayName;
                }
                
                // Fallback to email if displayName is not available
                if (user.email) {
                    return user.email;
                }

                return "Guest"; // Final fallback
            }

            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                console.log("Firebase auth state changed listener triggered.");
                const authStatusElement = document.getElementById('auth-status');
                const authButton = document.getElementById('auth-button');
                const profileDisplayName = document.getElementById('profile-display-name');
                const profileEmail = document.getElementById('profile-email');
                const emailVerificationStatus = document.getElementById('email-verification-status');
                const sendVerificationEmailButton = document.getElementById('send-verification-email-button');


                if (user) {
                    console.log("User initially in onAuthStateChanged:", user.displayName, user.email);
                    window.currentUser = user; 
                    await user.reload(); 
                    window.currentUser = auth.currentUser; 
                    console.log("User after reload in onAuthStateChanged:", window.currentUser.displayName, window.currentUser.email);

                    // Fetch user profile from Firestore to get custom display name
                    const profileResult = await window.getUserProfile(window.currentUser.uid);
                    let userDisplayName = window.currentUser.displayName;
                    if (profileResult.success && profileResult.profile.displayName) {
                        userDisplayName = profileResult.profile.displayName;
                    }
                    userDisplayName = userDisplayName || window.currentUser.email || "User"; // Fallback

                    console.log("DisplayName to use:", userDisplayName);

                    authStatusElement.textContent = `Signed in as: ${userDisplayName}`; 
                    profileDisplayName.textContent = userDisplayName; 

                    authButton.textContent = "My Profile";
                    authButton.onclick = () => openProfileModal();

                    emailVerificationStatus.innerHTML = `Email Verified: <span class="font-bold ${window.currentUser.emailVerified ? 'text-green-400' : 'text-yellow-400'}">${window.currentUser.emailVerified ? 'Yes' : 'No'}</span>`;
                    if (!window.currentUser.emailVerified) {
                        sendVerificationEmailButton.classList.remove('hidden');
                    } else {
                        sendVerificationEmailButton.classList.add('hidden');
                    }
                    
                    profileEmail.textContent = window.currentUser.email; 
                } else {
                    console.log("Auth state changed: User is signed out");
                    window.currentUser = null;
                    authStatusElement.textContent = "Signed out";
                    authButton.textContent = "Sign In / Register";
                    authButton.onclick = () => openAuthModal('signIn'); 
                    profileDisplayName.textContent = "Guest";
                    profileEmail.textContent = "Not signed in";
                    emailVerificationStatus.innerHTML = `Email Verified: <span class="font-bold text-gray-400">N/A</span>`;
                    sendVerificationEmailButton.classList.add('hidden');
                }
                updateUIForAuthStatus(); 
            });

            // Function to update UI elements based on auth status
            function updateUIForAuthStatus() {
                console.log("Updating UI for auth status.");
                const authButton = document.getElementById('auth-button');
                const authStatusElement = document.getElementById('auth-status');
                const profileDisplayNameElement = document.getElementById('profile-display-name');
                const profileEmailElement = document.getElementById('profile-email');
                const signOutButton = document.getElementById('profile-sign-out-button');
                const emailVerificationStatus = document.getElementById('email-verification-status');
                const sendVerificationEmailButton = document.getElementById('send-verification-email-button');


                if (window.currentUser) {
                    authButton.textContent = "My Profile";
                    authButton.onclick = openProfileModal;
                    
                    let userDisplayName = window.currentUser.displayName;
                    // Try to get from Firestore profile if not available directly from Auth
                    if (!userDisplayName) {
                        window.getUserProfile(window.currentUser.uid).then(profileResult => {
                            if (profileResult.success && profileResult.profile.displayName) {
                                userDisplayName = profileResult.profile.displayName;
                                authStatusElement.textContent = `Signed in as: ${userDisplayName || window.currentUser.email || "User"}`;
                                profileDisplayNameElement.textContent = userDisplayName || window.currentUser.email || "Guest";
                            }
                        });
                    }
                    userDisplayName = userDisplayName || window.currentUser.email || "User"; // Fallback for immediate display

                    console.log("DisplayName for updateUIForAuthStatus:", userDisplayName);
                    authStatusElement.textContent = `Signed in as: ${userDisplayName}`; 
                    profileDisplayNameElement.textContent = userDisplayName; 
                    
                    profileEmailElement.textContent = window.currentUser.email; 
                    emailVerificationStatus.innerHTML = `Email Verified: <span class="font-bold ${window.currentUser.emailVerified ? 'text-green-400' : 'text-yellow-400'}">${window.currentUser.emailVerified ? 'Yes' : 'No'}</span>`;
                    if (window.currentUser.email && !window.currentUser.emailVerified) { 
                        sendVerificationEmailButton.classList.remove('hidden');
                    } else {
                        sendVerificationEmailButton.classList.add('hidden');
                    }
                    
                    signOutButton.classList.remove('hidden');
                } else {
                    authButton.textContent = "Sign In / Register";
                    authButton.onclick = () => openAuthModal('signIn');
                    authStatusElement.textContent = "Signed out";
                    profileDisplayNameElement.textContent = "Guest";
                    profileEmailElement.textContent = "Not signed in";
                    emailVerificationStatus.innerHTML = `Email Verified: <span class="font-bold text-gray-400">N/A</span>`;
                    sendVerificationEmailButton.classList.add('hidden');
                    signOutButton.classList.add('hidden');
                }
            }
            // --- Sound Effects ---
            console.log("Initializing sound effects.");
            let allSoundEnabled = true; // Global flag for all sounds

            // Ensure Tone.js is loaded
            if (typeof Tone === 'undefined') {
                console.error("Tone.js not loaded. Please ensure the script tag is correct.");
            } else {
                console.log("Tone.js is defined. Setting up audio context listener.");
                // Initialize Tone.js context if not already running
                const startAudioContext = () => {
                    if (Tone.context.state !== 'running') {
                        Tone.start().then(() => {
                            console.log("Tone.js AudioContext started successfully.");
                        }).catch(e => console.error("Error starting Tone.js AudioContext:", e));
                    } else {
                        console.log("Tone.js AudioContext already running.");
                    }
                };

                // Attempt to start audio context on any user interaction
                document.documentElement.addEventListener('click', startAudioContext, { once: true });
                document.documentElement.addEventListener('keydown', startAudioContext, { once: true });


                // Synth for card hover sounds 
                const cardHoverSynth = new Tone.PolySynth(Tone.Synth, {
                    volume: -15, 
                    oscillator: { type: "sine" }, 
                    envelope: {
                        attack: 0.001,
                        decay: 0.03,
                        sustain: 0.01,
                        release: 0.03,
                        releaseCurve: "exponential" 
                    }
                }).toDestination();

                // Synth for button click sounds
                const buttonClickSynth = new Tone.PolySynth(Tone.Synth, {
                    volume: -15, // Matches card hover synth volume
                    oscillator: { type: "sine" }, // Matches card hover synth oscillator
                    envelope: {
                        attack: 0.001,
                        decay: 0.03,
                        sustain: 0.01,
                        release: 0.03,
                        releaseCurve: "exponential" // Matches card hover synth envelope
                    }
                }).toDestination();

                // Function to play a hover sound (for cards only now)
                function playCardHoverSound() {
                    if (!allSoundEnabled) {
                        return;
                    }
                    if (Tone.context.state === 'running') {
                        cardHoverSynth.triggerAttackRelease("G4", "64n"); 
                        console.log("Card hover sound played.");
                    } else {
                        console.warn("AudioContext not running for card hover. User interaction needed.");
                    }
                }

                // Function to play a click sound
                function playButtonClickSound() {
                    if (!allSoundEnabled) {
                        return;
                    }
                    if (Tone.context.state === 'running') {
                        buttonClickSynth.triggerAttackRelease("C5", "32n"); 
                        console.log("Button click sound played.");
                    } else {
                        console.warn("AudioContext not running for button click. User interaction needed.");
                    }
                }

                // Add event listeners to game cards for hover (only cards now)
                document.querySelectorAll('.game-card').forEach(card => {
                    card.addEventListener('mouseenter', playCardHoverSound);
                    // Add click listener to the card itself (not the button) for modal
                    card.addEventListener('click', (event) => {
                        // Prevent opening modal if a child button was clicked
                        if (event.target.closest('a')) {
                            console.log("Clicked a button inside card, not opening modal.");
                            playButtonClickSound(); // Play click sound for buttons
                            return;
                        }
                        playButtonClickSound(); // Play click sound for card click
                        openGameInfoModal(card.dataset.gameId);
                    });
                });

                // Add event listeners to play buttons for click (only click now)
                document.querySelectorAll('.play-button, .play-button-small, .coming-soon-button, #search-button, #toggle-all-sound-button, #close-game-info-modal, #auth-submit-button, #toggle-auth-mode, #close-auth-modal, #profile-sign-out-button, #close-profile-modal, #forgot-password-button, #google-sign-in-button, #send-verification-email-button, #close-notification-modal').forEach(button => {
                    button.addEventListener('click', playButtonClickSound); // Play click sound on click
                });


                // Mute/Unmute Button Logic
                const toggleAllSoundButton = document.getElementById('toggle-all-sound-button');
                const allSoundIcon = document.getElementById('all-sound-icon');

                toggleAllSoundButton.addEventListener('click', () => {
                    allSoundEnabled = !allSoundEnabled;
                    if (allSoundEnabled) {
                        Tone.Destination.volume.value = 0; // Unmute (0 dB)
                        allSoundIcon.classList.remove('fa-volume-mute');
                        allSoundIcon.classList.add('fa-volume-up');
                        console.log("All sounds unmuted.");
                    } else {
                        Tone.Destination.volume.value = -Infinity; // Mute completely
                        allSoundIcon.classList.remove('fa-volume-up');
                        allSoundIcon.classList.add('fa-volume-mute');
                        console.log("All sounds muted.");
                    }
                    // Ensure audio context is started if unmuting
                    if (allSoundEnabled && Tone.context.state !== 'running') {
                        startAudioContext();
                    }
                });
            }

            // --- Game Info Modal Logic ---
            console.log("Initializing Game Info Modal logic.");
            const gameInfoModal = document.getElementById('game-info-modal');
            const closeGameInfoModalButton = document.getElementById('close-game-info-modal');
            const modalGameTitle = document.getElementById('modal-game-title');
            const modalGameDescription = document.getElementById('modal-game-description');
            const modalGameRules = document.getElementById('modal-game-rules');

            const gameDetails = {
                "2048": {
                    title: "2048",
                    description: "Merge identical tiles to reach the 2048 tile! Slide tiles by swiping or using arrow keys. When two tiles with the same number touch, they merge into one. Keep merging to score higher and reach the ultimate tile!",
                    rules: "Use arrow keys or swipe to move tiles. Tiles with the same number merge into one. The game ends when the board is full and no more moves are possible."
                },
                "ticTacToe": {
                    title: "Tic-Tac-Toe",
                    description: "A classic strategy game for two players, 'X' and 'O', who take turns marking the spaces in a 3x3 grid. The player who succeeds in placing three of their marks in a horizontal, vertical, or diagonal row wins the game.",
                    rules: "Players take turns marking a square. The first player to get three of their marks in a row (horizontal, vertical, or diagonal) wins."
                },
                "hangman": {
                    title: "Hangman",
                    description: "Guess the hidden word one letter at a time to save the stick figure from being hanged. Each wrong guess adds another part to the gallows! Be careful with your guesses!",
                    rules: "Guess letters. For each incorrect guess, a part of the hangman is drawn. You lose if the hangman is complete before you guess the word."
                }
            };

            function openGameInfoModal(gameId) {
                const details = gameDetails[gameId];
                if (details) {
                    modalGameTitle.textContent = details.title;
                    modalGameDescription.textContent = details.description;
                    modalGameRules.textContent = "Rules: " + details.rules;
                    gameInfoModal.classList.remove('hidden');
                } else {
                    console.error("Game details not found for ID:", gameId);
                }
            }

            closeGameInfoModalButton.addEventListener('click', () => {
                gameInfoModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            gameInfoModal.addEventListener('click', (event) => {
                if (event.target === gameInfoModal) {
                    gameInfoModal.classList.add('hidden');
                }
            });


            // --- Search Functionality ---
            console.log("Initializing Search Functionality.");
            const gameSearchInput = document.getElementById('game-search');
            const allGameCards = document.querySelectorAll('.game-card');

            gameSearchInput.addEventListener('input', () => {
                const searchTerm = gameSearchInput.value.toLowerCase();
                allGameCards.forEach(card => {
                    const title = card.querySelector('.game-card-title').textContent.toLowerCase();
                    const description = card.querySelector('.game-card-description').textContent.toLowerCase();
                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        card.style.display = ''; // Show card
                    } else {
                        card.style.display = 'none'; // Hide card
                    }
                });
            });

            // Optional: Trigger search on button click as well
            document.getElementById('search-button').addEventListener('click', () => {
                const searchTerm = gameSearchInput.value.toLowerCase(); // Re-read value on click
                allGameCards.forEach(card => {
                    const title = card.querySelector('.game-card-title').textContent.toLowerCase();
                    const description = card.querySelector('.game-card-description').textContent.toLowerCase();
                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        card.style.display = ''; // Show card
                    } else {
                        card.style.display = 'none'; // Hide card
                    }
                });
            });

            // --- Smooth Page Transitions ---
            console.log("Initializing Smooth Page Transitions.");
            document.querySelectorAll('a[href^="http"]:not([target="_blank"]), a[href^="game.html"], a[href^="tic_tac_toe.html"], a[href^="tic_tac_toe_ai.html"], a[href^="hangman.html"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    // All internal links that are not game buttons should trigger fade-out
                    // The 'play-button' and 'play-button-small' now have their own click handlers.
                    // This listener is for other navigation links that should fade out.
                    if (this.classList.contains('play-button') || this.classList.contains('play-button-small') || this.classList.contains('coming-soon-button')) {
                        return; // Let their specific handlers take over
                    }

                    e.preventDefault(); // Prevent default navigation immediately
                    const destination = this.href;

                    // Add a class to body to trigger fade-out animation
                    document.body.classList.add('fade-out');

                    // Navigate after animation duration
                    setTimeout(() => {
                        window.location.href = destination;
                    }, 500); // Match CSS transition duration (0.5s)
                });
            });

            // Add fade-in on page load
            document.addEventListener('DOMContentLoaded', () => {
                console.log("DOMContentLoaded event fired. Adding fade-in class.");
                // Set initial opacity to 0 in CSS, then fade in on load
                document.body.classList.add('fade-in');
            });

            // Handle browser back/forward buttons to ensure proper fade-in
            window.addEventListener('pageshow', (event) => {
                if (event.persisted) { // If page is loaded from cache (e.g., via back button)
                    console.log("pageshow event (persisted) fired. Ensuring fade-in and resetting body classes.");
                    document.body.classList.remove('fade-out'); // Remove fade-out class if present
                    // Small delay to ensure browser fully renders before fade-in
                    setTimeout(() => {
                        document.body.classList.add('fade-in'); // Ensure fade-in animation plays
                    }, 10); 
                }
            });


            // --- Authentication Modals Logic ---
            console.log("Initializing Authentication Modals Logic.");
            const authModal = document.getElementById('auth-modal');
            const closeAuthModalButton = document.getElementById('close-auth-modal');
            const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
            const authModalTitle = document.getElementById('auth-modal-title');
            const authForm = document.getElementById('auth-form');
            const authEmailInput = document.getElementById('auth-email');
            const authPasswordInput = document.getElementById('auth-password');
            const authDisplayNameInput = document.getElementById('auth-display-name');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authErrorMessage = document.getElementById('auth-error-message');
            const forgotPasswordButton = document.getElementById('forgot-password-button');
            const googleSignInButton = document.getElementById('google-sign-in-button');

            const profileModal = document.getElementById('profile-modal');
            const closeProfileModalButton = document.getElementById('close-profile-modal');
            const profileSignOutButton = document.getElementById('profile-sign-out-button');
            const emailVerificationStatus = document.getElementById('email-verification-status');
            const sendVerificationEmailButton = document.getElementById('send-verification-email-button');

            const notificationModal = document.getElementById('notification-modal');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const closeNotificationModalButton = document.getElementById('close-notification-modal');


            let isSignInMode = true; // State for auth modal

            window.openAuthModal = (mode = 'signIn') => {
                console.log(`Opening Auth Modal in ${mode} mode.`);
                isSignInMode = (mode === 'signIn');
                authModalTitle.textContent = isSignInMode ? "Sign In" : "Register";
                authSubmitButton.textContent = isSignInMode ? "Sign In" : "Register";
                toggleAuthModeButton.textContent = isSignInMode ? "Don't have an account? Register" : "Already have an account? Sign In";
                authDisplayNameInput.classList.toggle('hidden', isSignInMode);
                forgotPasswordButton.classList.toggle('hidden', !isSignInMode); // Show only in Sign In mode
                authErrorMessage.classList.add('hidden'); // Clear previous errors
                authModal.classList.remove('hidden');
            };

            window.openProfileModal = async () => {
                console.log("Attempting to open Profile Modal.");
                if (window.currentUser) {
                    document.getElementById('profile-display-name').textContent = "Loading..."; // Set loading state
                    document.getElementById('profile-email').textContent = window.currentUser.email;

                    await window.currentUser.reload();
                    window.currentUser = auth.currentUser; 

                    emailVerificationStatus.innerHTML = `Email Verified: <span class="font-bold ${window.currentUser.emailVerified ? 'text-green-400' : 'text-yellow-400'}">${window.currentUser.emailVerified ? 'Yes' : 'No'}</span>`;
                    if (window.currentUser.email && !window.currentUser.emailVerified) { 
                        sendVerificationEmailButton.classList.remove('hidden');
                    } else {
                        sendVerificationEmailButton.classList.add('hidden');
                    }

                    let displayNameToUse = window.currentUser.displayName;
                    if (!displayNameToUse) {
                        const profileResult = await window.getUserProfile(window.currentUser.uid);
                        if (profileResult.success && profileResult.profile.displayName) {
                            displayNameToUse = profileResult.profile.displayName;
                        }
                    }
                    document.getElementById('profile-display-name').textContent = displayNameToUse || window.currentUser.email || "Guest";
                    
                    profileModal.classList.remove('hidden');
                } else {
                    console.warn("No user signed in to open profile modal. Redirecting to sign in.");
                    openAuthModal('signIn'); 
                }
            };

            closeAuthModalButton.addEventListener('click', () => {
                console.log("Closing Auth Modal.");
                authModal.classList.add('hidden');
            });

            toggleAuthModeButton.addEventListener('click', () => {
                console.log("Toggling Auth Mode.");
                isSignInMode = !isSignInMode;
                openAuthModal(isSignInMode ? 'signIn' : 'register');
            });

            forgotPasswordButton.addEventListener('click', async () => {
                const email = authEmailInput.value;
                if (!email) {
                    authErrorMessage.textContent = "Please enter your email to reset password.";
                    authErrorMessage.classList.remove('hidden');
                    return;
                }
                const result = await window.sendPasswordReset(email);
                if (result.success) {
                    openNotificationModal("Password Reset", result.message);
                    authModal.classList.add('hidden'); 
                } else {
                    authErrorMessage.textContent = result.error;
                    authErrorMessage.classList.remove('hidden');
                }
            });

            googleSignInButton.addEventListener('click', async () => {
                const result = await window.signInWithGoogle();
                if (result.success) {
                    authModal.classList.add('hidden');
                    const userForNotification = window.currentUser; 
                    const displayNameForNotification = userForNotification.displayName || userForNotification.email || "User";
                    openNotificationModal("Google Sign-In", `Welcome, ${displayNameForNotification}!`);
                } else {
                    authErrorMessage.textContent = result.error;
                    authErrorMessage.classList.remove('hidden');
                }
            });


            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("Auth form submitted.");
                authErrorMessage.classList.add('hidden'); 

                const email = authEmailInput.value;
                const password = authPasswordInput.value;
                const displayName = authDisplayNameInput.value;

                if (isSignInMode) {
                    console.log("Attempting sign in.");
                    const result = await window.signIn(email, password);
                    if (result.success) {
                        authModal.classList.add('hidden');
                        const userForNotification = window.currentUser; 
                        const displayNameForNotification = userForNotification.displayName || userForNotification.email || "User";
                        openNotificationModal("Sign In Successful", `Welcome back, ${displayNameForNotification}!`);
                    } else {
                        authErrorMessage.textContent = result.error;
                        authErrorMessage.classList.remove('hidden');
                    }
                } else {
                    console.log("Attempting registration.");
                    const result = await window.signUp(email, password, displayName);
                    if (result.success) {
                        authModal.classList.add('hidden');
                        openNotificationModal("Registration Successful!", `A verification email has been sent to ${result.user.email}. Please verify your email to fully activate your account.`);
                    } else {
                        authErrorMessage.textContent = result.error;
                        authErrorMessage.classList.remove('hidden');
                    }
                }
            });

            closeProfileModalButton.addEventListener('click', () => {
                console.log("Closing Profile Modal.");
                profileModal.classList.add('hidden');
            });

            profileSignOutButton.addEventListener('click', async () => {
                console.log("Sign out button clicked.");
                const result = await window.signOutUser();
                if (result.success) {
                    console.log("Sign out successful, closing profile modal.");
                    profileModal.classList.add('hidden');
                    openNotificationModal("Signed Out", "You have been successfully signed out.");
                }
            });

            sendVerificationEmailButton.addEventListener('click', async () => {
                const result = await window.sendVerificationEmail();
                if (result.success) {
                    openNotificationModal("Verification Sent", result.message);
                } else {
                    openNotificationModal("Error", result.error, "red");
                }
            });

            // Close modals when clicking outside
            authModal.addEventListener('click', (event) => {
                if (event.target === authModal) {
                    console.log("Clicked outside Auth Modal, closing.");
                    authModal.classList.add('hidden');
                }
            });
            profileModal.addEventListener('click', (event) => {
                if (event.target === profileModal) {
                    console.log("Clicked outside Profile Modal, closing.");
                    profileModal.classList.add('hidden');
                }
            });
            notificationModal.addEventListener('click', (event) => {
                if (event.target === notificationModal) {
                    notificationModal.classList.add('hidden');
                }
            });
            closeNotificationModalButton.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });

            // Helper function to open generic notification modal
            function openNotificationModal(title, message, type = "blue") {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                notificationTitle.className = `text-xl font-bold mb-3 text-${type}-400`; 
                notificationModal.classList.remove('hidden');
            }


        } catch (e) {
            console.error("Critical error in main script block:", e);
            document.body.innerHTML = `<div style="color: red; padding: 20px; font-size: 24px;">Error loading page: ${e.message}. Please check the developer console for details.</div>`;
        }
        console.log("--- Main script execution finished ---"); 
    </script>
</body>
</html>
